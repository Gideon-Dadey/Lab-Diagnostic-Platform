import{j as e,c as t}from"./ui-vendor-D_YnDhxq.js";import{u as a,c as s,a as r}from"./react-vendor-B1YRfcvv.js";import{l as i}from"./index-CYtxp7L5.js";import{V as n,ar as o,as as l,at as c,G as d,au as m,K as g}from"./index-BpOdPcLd.js";import"./redux-vendor-Cc4mDNFq.js";import"./utils-vendor-B4hhIH4d.js";const x=(e,t="en-GB",a="USD")=>new Intl.NumberFormat(t,{style:"currency",currency:a}).format(e||0);function u(){const u=a(),h=s(),[p,y]=r.useState(!0),[b,j]=r.useState(!1),[f,N]=r.useState([]),[v,S]=r.useState(""),[w,k]=r.useState(null),[I,E]=r.useState(()=>{try{return JSON.parse(localStorage.getItem("bookingData"))||{}}catch{return{}}}),[T,_]=r.useState(!1),C={SAVE10:{code:"SAVE10",type:"percent",value:10,label:"10% off"},FLAT50:{code:"FLAT50",type:"flat",value:50,label:"PKR 50 off"}};r.useEffect(()=>{if(h.state&&h.state.booking)try{const e=h.state.booking;E(e),localStorage.setItem("bookingData",JSON.stringify(e))}catch(e){}},[h.state]),r.useEffect(()=>{let e=!0;const a=localStorage.getItem("authToken")||sessionStorage.getItem("authToken");return async function(){y(!0);try{if(!a)return t.error("Please log in to review and pay."),void u("/login");const s=await fetch("/api/cart",{headers:{Authorization:a?`Bearer ${a}`:"","Content-Type":"application/json"}});if(s.ok){const t=await s.json();let a=(Array.isArray(t.cartItems)?t.cartItems:[]).map(e=>({_id:e._id||e.id,name:e.name,price:Number(e.price)||0,quantity:Number(e.quantity)||1}));if(!a.length)try{const e=JSON.parse(localStorage.getItem("cartItems")||"[]");if(Array.isArray(e)&&e.length)a=e.map(e=>({_id:e._id||e.id,name:e.name,price:Number(e.price)||0,quantity:Number(e.quantity)||1}));else{const e=JSON.parse(localStorage.getItem("persist:cart")||"{}").items,t=e?JSON.parse(e):[];Array.isArray(t)&&t.length&&(a=t.map(e=>({_id:e._id||e.id,name:e.name,price:Number(e.price)||0,quantity:Number(e.quantity)||1})))}}catch{}e&&(N(a),localStorage.setItem("cartItems",JSON.stringify(a)))}else{let t=[];try{t=JSON.parse(localStorage.getItem("cartItems")||"[]")}catch{}if(!(null==t?void 0:t.length))try{const e=JSON.parse(localStorage.getItem("persist:cart")||"{}").items,a=e?JSON.parse(e):[];t=Array.isArray(a)?a.map(e=>({_id:e._id||e.id,name:e.name,price:Number(e.price)||0,quantity:Number(e.quantity)||1})):[]}catch{}e&&N(t)}}catch(s){let t=[];try{t=JSON.parse(localStorage.getItem("cartItems")||"[]")}catch{}if(!(null==t?void 0:t.length))try{const e=JSON.parse(localStorage.getItem("persist:cart")||"{}").items,a=e?JSON.parse(e):[];t=Array.isArray(a)?a.map(e=>({_id:e._id||e.id,name:e.name,price:Number(e.price)||0,quantity:Number(e.quantity)||1})):[]}catch{}e&&N(t)}finally{e&&y(!1)}}(),()=>{e=!1}},[]);const P=r.useMemo(()=>f.reduce((e,t)=>e+(Number(t.price)||0)*(Number(t.quantity)||1),0),[f]),A=r.useMemo(()=>w?"percent"===w.type?w.value/100*P:"flat"===w.type?w.value:0:0,[w,P]),O=r.useMemo(()=>Math.max(0,.05*(P-A)),[P,A]),q=r.useMemo(()=>Math.max(0,P-A+O),[P,A,O]),J=e=>e||"—";return e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsxs("button",{onClick:()=>u(-1),className:"inline-flex items-center gap-2 text-indigo-600 hover:text-indigo-800 focus:outline-none","aria-label":"Back",children:[e.jsx(n,{})," Back"]}),e.jsx("h1",{className:"text-2xl font-semibold text-gray-900",children:"Review & Pay"}),e.jsx("div",{className:"ml-auto text-sm text-gray-500",children:"Secure checkout • Encrypted • Clinician-reviewed"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("section",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-6",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Patient & Booking"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Confirm the details below before proceeding to payment."})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>u("/place-order"),className:"inline-flex items-center gap-2 text-sm text-indigo-600 hover:underline","aria-label":"Edit booking",children:[e.jsx(o,{})," Edit"]})})]}),e.jsxs("div",{className:"mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"rounded-lg bg-indigo-50 p-4",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Full name"}),e.jsx("div",{className:"font-medium text-gray-800",children:J(I.name)})]}),e.jsxs("div",{className:"rounded-lg bg-indigo-50 p-4",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Phone"}),e.jsx("div",{className:"font-medium text-gray-800",children:J(I.phoneNumber)})]}),e.jsxs("div",{className:"rounded-lg bg-indigo-50 p-4",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Email"}),e.jsx("div",{className:"font-medium text-gray-800",children:J(I.email)})]}),e.jsxs("div",{className:"rounded-lg bg-indigo-50 p-4",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Collection"}),e.jsx("div",{className:"font-medium text-gray-800",children:J(I.collectionMethod)})]}),e.jsxs("div",{className:"sm:col-span-2 rounded-lg bg-indigo-50 p-4",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Address"}),e.jsx("div",{className:"font-medium text-gray-800",children:J(I.address)})]}),e.jsxs("div",{className:"rounded-lg bg-indigo-50 p-4",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Date"}),e.jsx("div",{className:"font-medium text-gray-800",children:J(I.bookingDate)})]}),e.jsxs("div",{className:"rounded-lg bg-indigo-50 p-4",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Time"}),e.jsx("div",{className:"font-medium text-gray-800",children:J(I.bookingTime)})]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Cart Items"}),e.jsxs("div",{className:"text-sm text-gray-500",children:[f.length," item",1!==f.length?"s":""]})]}),p?e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-16 rounded-lg bg-gray-100 animate-pulse"}),e.jsx("div",{className:"h-16 rounded-lg bg-gray-100 animate-pulse"})]}):0===f.length?e.jsxs("div",{className:"mt-4 text-gray-500",children:["Your cart is empty. ",e.jsx("button",{onClick:()=>u("/tests-by-concern"),className:"text-indigo-600 hover:underline",children:"Browse tests"})]}):e.jsx("div",{className:"mt-4 space-y-3",children:f.map(a=>e.jsx("div",{className:"flex items-center gap-4 border rounded-lg p-3",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-medium text-gray-900 truncate",children:a.name}),e.jsx("div",{className:"text-sm text-gray-600",children:x(a.price)})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-3",children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Qty"}),e.jsx("input",{type:"number",min:1,value:a.quantity,onChange:e=>((e,t)=>{if(t<1)return;N(a=>{const s=a.map(a=>a._id===e?{...a,quantity:t}:a);return localStorage.setItem("cartItems",JSON.stringify(s)),s});const a=localStorage.getItem("authToken")||sessionStorage.getItem("authToken");a&&fetch(`/api/cart/update/${e}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({quantity:t})}).catch(e=>{})})(a._id,Math.max(1,Number(e.target.value||1))),className:"w-20 px-2 py-1 rounded border border-gray-200 text-sm","aria-label":`Quantity for ${a.name}`}),e.jsxs("button",{onClick:()=>(e=>{const a=f,s=f.filter(t=>t._id!==e);N(s),localStorage.setItem("cartItems",JSON.stringify(s));const r=localStorage.getItem("authToken")||sessionStorage.getItem("authToken");r?fetch(`/api/cart/remove/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${r}`}}).then(e=>{if(!e.ok)throw new Error("Delete failed");t.success("Item removed")}).catch(e=>{N(a),localStorage.setItem("cartItems",JSON.stringify(a)),t.error("Could not remove item. Please try again.")}):t.success("Item removed")})(a._id),className:"ml-auto inline-flex items-center gap-2 text-sm text-red-600 hover:underline","aria-label":`Remove ${a.name}`,children:[e.jsx(l,{})," Remove"]})]})]})},a._id))})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Promo code & notes"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Save on your booking"})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3 items-center",children:[e.jsxs("div",{className:"sm:col-span-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{value:v,onChange:e=>S(e.target.value),placeholder:"Enter promo code (e.g. SAVE10)",className:"w-full px-4 py-2 rounded border border-gray-200","aria-label":"Promo code"}),e.jsx(c,{className:"absolute right-3 top-3 text-gray-300"})]}),w&&e.jsxs("div",{className:"mt-2 text-sm text-green-600 inline-flex items-center gap-2",children:[e.jsx(d,{})," ",w.label,e.jsx("button",{onClick:()=>{k(null),S(""),t.success("Promo removed")},className:"ml-3 text-sm text-gray-500 hover:underline",children:"Remove"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>{const e=(v||"").trim().toUpperCase();if(!e)return void t.error("Enter a promo code");const a=C[e];a?(k(a),t.success(`${a.label} applied`)):t.error("Invalid promo code")},className:"inline-flex items-center gap-2 justify-center px-4 py-2 rounded bg-indigo-600 text-white",children:[e.jsx(m,{})," Apply"]}),e.jsx("button",{onClick:()=>{S(""),k(null)},className:"px-4 py-2 rounded border border-gray-200",children:"Reset"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"text-sm text-gray-500",children:"Notes for lab / phlebotomist (optional)"}),e.jsx("textarea",{defaultValue:I.notes||"",onBlur:e=>{const t=e.target.value,a={...I,notes:t};E(a),localStorage.setItem("bookingData",JSON.stringify(a))},placeholder:"Any access notes, preferences or medical information",className:"w-full mt-2 p-3 border rounded border-gray-200 min-h-[80px]"})]})]})]}),e.jsx("aside",{children:e.jsxs("div",{className:"sticky top-6 bg-white border border-gray-100 rounded-xl shadow-sm p-6 w-full max-w-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600 font-semibold",children:I.package?String(I.package).charAt(0).toUpperCase():"B"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Selected package"}),e.jsx("div",{className:"font-semibold text-gray-900",children:I.package||"Custom booking"})]})]}),e.jsxs("div",{className:"mt-5 border-t pt-4 text-sm space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-gray-600",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:x(P)})]}),e.jsxs("div",{className:"flex justify-between text-gray-600",children:[e.jsx("span",{children:"Discount"}),e.jsxs("span",{children:["-",x(A)]})]}),e.jsxs("div",{className:"flex justify-between text-gray-600",children:[e.jsxs("span",{children:["Tax (",5..toFixed(0),"%)"]}),e.jsx("span",{children:x(O)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold text-indigo-700 pt-2 border-t pt-3",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:x(q)})]})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("button",{onClick:async()=>{var e;if(0===f.length)return void t.error("Your cart is empty.");if(!I||!I.collectionMethod)return t.error("Please select a collection method in the booking form."),void u("/place-order");const a=localStorage.getItem("authToken")||sessionStorage.getItem("authToken");if(!a)return t.error("You need to log in to proceed with payment."),void u("/login");j(!0),_(!0);try{const s={name:I.name,email:I.email,phoneNumber:I.phoneNumber,gender:I.gender,age:I.age,address:I.address,state:I.state,country:I.country,collectionMethod:I.collectionMethod,bookingDate:I.bookingDate,bookingTime:I.bookingTime,paymentStatus:"pending",items:f.map(e=>({name:e.name,price:Number(e.price)||0,quantity:Number(e.quantity)||1,type:e.type||"Package",labId:e.labId,testOrPackageId:e.testOrPackageId||e._id}))},r=await fetch("/api/orders/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(s)}),n=await r.json();if(!r.ok)throw new Error(n.message||"Failed to create order");const o=(null==(e=null==n?void 0:n.order)?void 0:e._id)||(null==n?void 0:n._id);if(!o)throw new Error("No order id returned from server");const l=await fetch("/api/payment/create-checkout-session",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({bookingId:o})}),c=await l.json();if(!l.ok||!c.id)throw new Error(c.message||"Failed to create checkout session");let d="pk_test_51S6UfLKteAtM6EfyngvpQoXMzIE8IUPeeglOhO0QXMXWqnmIYgjH5EqMuPlaw5MfmkX8ikSQzG4c6R12QYqQSywG00hbLkGRgt".trim();if(!d)try{const e=await fetch("/api/payment/public-key");d=((await e.json()).publishableKey||"").trim(),d&&localStorage.setItem("PUBLIC_STRIPE_KEY",d)}catch{}if(!d&&"undefined"!=typeof window){const e=window.prompt("Enter Stripe publishable key (starts with pk_)")||"";e&&e.trim().startsWith("pk_")&&(d=e.trim(),localStorage.setItem("PUBLIC_STRIPE_KEY",d))}if(!d)throw new Error("Stripe publishable key is missing. Set VITE_STRIPE_PUBLISHABLE_KEY.");const m=await i(d);if(!m)throw new Error("Stripe failed to initialize");const g=await m.redirectToCheckout({sessionId:c.id});(null==g?void 0:g.error)&&t.error("Stripe redirect failed. Try again.")}catch(s){t.error(s.message||"Payment failed"),j(!1),_(!1)}},disabled:b||T,className:"w-full inline-flex items-center justify-center gap-3 px-4 py-2 rounded bg-gradient-to-r from-indigo-600 to-indigo-500 text-white font-semibold hover:from-indigo-700 disabled:opacity-60","aria-disabled":b||T,children:[b?e.jsx(g,{className:"animate-spin"}):null,b?"Redirecting...":`Pay ${x(q)}`]})}),e.jsxs("div",{className:"mt-3 text-xs text-gray-500",children:["By paying you agree to our ",e.jsx("button",{onClick:()=>u("/terms"),className:"underline",children:"Terms"})," and ",e.jsx("button",{onClick:()=>u("/privacy"),className:"underline",children:"Privacy"}),"."]})]})})]})]})}export{u as default};
