import{j as e,c as s}from"./ui-vendor-D_YnDhxq.js";import{a as t}from"./react-vendor-B1YRfcvv.js";import{a}from"./utils-vendor-B4hhIH4d.js";import{u as l,e as r}from"./redux-vendor-Cc4mDNFq.js";import{ag as i,aa as n,L as d,aK as o,a as c,aq as m}from"./index-BpOdPcLd.js";const u=e=>"number"==typeof e?`PKR ${e.toLocaleString(void 0,{maximumFractionDigits:0})}`:e||"PKR 0";function x(){return e.jsxs("div",{className:"bg-white rounded-xl shadow-sm overflow-hidden animate-pulse",children:[e.jsx("div",{className:"h-6 bg-gray-200"}),e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 mt-3 w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 mt-2 w-1/2"}),e.jsx("div",{className:"h-8 bg-gray-200 mt-4 w-full rounded"})]})]})}function g({count:s=0}){return e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(c,{"aria-hidden":!0}),e.jsx("span",{children:s})]})}const p=()=>{const o=l(),c=r(e=>e.cart.items||[]),[p,b]=t.useState([]),[v,j]=t.useState({}),[y,f]=t.useState(""),N=function(e,s=300){const[a,l]=t.useState(e);return t.useEffect(()=>{const t=setTimeout(()=>l(e),s);return()=>clearTimeout(t)},[e,s]),a}(y,300),[w,k]=t.useState({priceRange:[0,1e5],lab:"",type:"",sort:"popular"}),[C,S]=t.useState(!1),[L,_]=t.useState(null),[P,R]=t.useState(9),[T,E]=t.useState(null),[F,A]=t.useState(!0),[M,I]=t.useState(null),B=t.useRef(!0);t.useEffect(()=>{B.current=!0;const e=new AbortController;return async function(){A(!0),I(null);try{const[s,t,l]=await Promise.allSettled([a.get("/api/tests/public-tests",{signal:e.signal}),a.get("/api/tests/public-packages",{signal:e.signal}),a.get("/api/labs/get-all",{signal:e.signal})]);if("fulfilled"===s.status){const e=s.value.data;(null==e?void 0:e.success)&&b(s=>[...s,...e.tests||[]])}if("fulfilled"===t.status){const e=t.value.data;if(null==e?void 0:e.success){const s=(e.packages||[]).map(e=>{var s;return{...e,type:"Package",lab:(null==(s=e.lab)?void 0:s._id)||e.lab}});b(e=>[...e,...s])}}if("fulfilled"===l.status){const e=l.value.data;if(null==e?void 0:e.success){const s={};(e.labs||[]).forEach(e=>{s[e._id]=e}),j(s)}}}catch(s){a.isCancel(s)||B.current&&I("Unable to load data. Please try again.")}finally{B.current&&A(!1)}}(),()=>{B.current=!1,e.abort()}},[]),t.useEffect(()=>{R(9)},[N,w.lab,w.type,w.priceRange,w.sort]);const U=t.useMemo(()=>Object.values(v).filter((e,s,t)=>t.findIndex(s=>s._id===e._id)===s),[v]),q=e=>{const s=Number(e.price||0),t=Number(e.discount||0);return t>0&&t<=100?Math.round(s*(1-t/100)):s},O=t.useMemo(()=>{const e=(N||"").trim().toLowerCase();let s=p.filter(s=>{var t,a,l,r;const i=q(s),n=i>=((null==(t=w.priceRange)?void 0:t[0])??0)&&i<=((null==(a=w.priceRange)?void 0:a[1])??Number.MAX_SAFE_INTEGER),d="object"==typeof s.lab?null==(l=s.lab)?void 0:l._id:s.lab,o=!w.lab||String(d)===String(w.lab),c=!w.type||("Package"===w.type?"Package"===s.type:"Test"!==w.type||"Package"!==s.type),m=!e||[s.name,s.description,s.type,s.lab&&("object"==typeof s.lab?s.lab.name:null==(r=v[s.lab])?void 0:r.name)||""].filter(Boolean).join(" ").toLowerCase().includes(e);return n&&o&&c&&m});return"low"===w.sort?s.sort((e,s)=>q(e)-q(s)):"high"===w.sort?s.sort((e,s)=>q(s)-q(e)):"rating"===w.sort?s.sort((e,s)=>(s.rating||0)-(e.rating||0)):s.sort((e,s)=>(s.popularity||0)-(e.popularity||0)),s},[p,N,w,v]),$=O.slice(0,P),z=async e=>{var t,l,r,i,n,d,u,x;const g=e._id||e.id;try{_(g);const u=q(e),x=c.find(e=>e._id===g),p=x?x.quantity+1:1,h={testOrPackageId:g,type:e.type||"Test",name:e.name,price:u,labId:(null==(t=e.lab)?void 0:t._id)||e.lab||"Unknown",quantity:p},b=await a.post("/api/cart/add",h,{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}});if(null==(l=b.data)?void 0:l.success){const t={_id:b.data.itemId||g,name:e.name,price:u,type:e.type||"Test",labId:(null==(r=e.lab)?void 0:r._id)||e.lab||"Unknown",labName:(null==(i=e.lab)?void 0:i.name)||(null==(n=v[e.lab])?void 0:n.name)||"Unknown Lab",quantity:1};o(m(t)),s.success("Added to cart")}else s.error((null==(d=b.data)?void 0:d.message)||"Failed to add to cart")}catch(p){s.error((null==(x=null==(u=p.response)?void 0:u.data)?void 0:x.message)||"Unable to add to cart")}finally{_(null)}};return t.useEffect(()=>{if(!T)return;const e=e=>{"Escape"===e.key&&E(null)};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[T]),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"text-center mb-10",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800 mb-2",children:"Find Medical Tests & Packages"}),e.jsx("p",{className:"text-gray-600 max-w-2xl mx-auto",children:"Compare tests from trusted partner labs with transparent pricing and fast turnaround times."})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-4 mb-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("label",{htmlFor:"test-search",className:"sr-only",children:"Search tests"}),e.jsx("input",{id:"test-search",type:"search",placeholder:"Search tests (e.g., CBC, Lipid Profile, Full Body)...",className:"w-full pl-4 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary outline-none",value:y,onChange:e=>f(e.target.value)}),e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","aria-hidden":!0,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})})]}),e.jsxs("button",{onClick:()=>S(e=>!e),className:"flex items-center gap-2 px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors","aria-expanded":C,"aria-controls":"tests-filters",children:[e.jsx(i,{}),e.jsx("span",{children:"Filters"})]})]}),C&&e.jsxs("div",{id:"tests-filters",className:"mt-4 p-4 border-t border-gray-200",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Min Price"}),e.jsx("input",{type:"number",value:w.priceRange[0],onChange:e=>k(s=>({...s,priceRange:[Number(e.target.value||0),s.priceRange[1]]})),className:"mt-1 p-2 w-full border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Max Price"}),e.jsx("input",{type:"number",value:w.priceRange[1],onChange:e=>k(s=>({...s,priceRange:[s.priceRange[0],Number(e.target.value||1e5)]})),className:"mt-1 p-2 w-full border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Lab"}),e.jsxs("select",{value:w.lab,onChange:e=>k(s=>({...s,lab:e.target.value})),className:"mt-1 p-2 w-full border rounded",children:[e.jsx("option",{value:"",children:"All Labs"}),U.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Sort"}),e.jsxs("select",{value:w.sort,onChange:e=>k(s=>({...s,sort:e.target.value})),className:"mt-1 p-2 w-full border rounded",children:[e.jsx("option",{value:"popular",children:"Most Popular"}),e.jsx("option",{value:"low",children:"Price: Low to High"}),e.jsx("option",{value:"high",children:"Price: High to Low"}),e.jsx("option",{value:"rating",children:"Highest Rating"})]})]})]}),e.jsx("div",{className:"mt-4 flex items-center gap-3",children:e.jsx("button",{onClick:()=>k({priceRange:[0,1e5],lab:"",type:"",sort:"popular"}),className:"px-3 py-2 bg-gray-100 rounded hover:bg-gray-200",children:"Reset Filters"})})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between items-start md:items-center gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-lg font-semibold text-primary mr-2",children:"Total:"}),e.jsxs("span",{className:"font-bold bg-primary/10 text-primary px-3 py-1 rounded-full",children:[O.length," ",1===O.length?"Test":"Tests"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[O.length>P&&e.jsx("button",{onClick:()=>R(e=>Math.min(O.length,e+9)),className:"px-3 py-2 bg-gray-100 rounded hover:bg-gray-200",children:"Load more"}),O.length>9&&e.jsx("button",{onClick:()=>R(e=>e>=O.length?9:O.length),className:"px-3 py-2 bg-primary text-white rounded hover:bg-primary-dark",children:P>=O.length?"Show less":"View all"})]})]}),M&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded",children:M}),F?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:Array.from({length:6}).map((s,t)=>e.jsx(x,{},t))}):0===O.length?e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-gray-500",children:"No tests match your search and filters."})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:$.map(s=>{const t="object"==typeof s.lab?s.lab:v[s.lab],a=(null==t?void 0:t.name)||"Unknown Lab",l=q(s),r=Number(s.discount||0)>0,i=r?`${Number(s.discount)}% OFF`:null;return e.jsx("article",{className:"bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition",children:e.jsxs("div",{className:"p-5",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("span",{className:"inline-block px-2 py-1 text-xs font-semibold bg-blue-50 text-blue-700 rounded-full",children:s.type||"Test"}),e.jsx(g,{count:s.bookedCount||0})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-800",children:s.name}),e.jsx("div",{className:"text-sm text-gray-600",children:e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-primary font-semibold",children:u(l)}),r&&e.jsx("div",{className:"text-xs text-gray-500 line-through",children:u(Number(s.price||0))}),i&&e.jsx("div",{className:"text-xs bg-red-100 text-red-700 inline-block px-2 py-0.5 rounded mt-1",children:i})]})})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-3 text-sm text-gray-600",children:[e.jsx(n,{}),e.jsx("span",{className:"truncate",children:a})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-2 gap-3",children:[e.jsx("button",{onClick:()=>E(s),className:"px-3 py-2 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition-colors",children:"View details"}),e.jsx("button",{onClick:()=>z(s),disabled:L===(s._id||s.id),className:"px-3 py-2 rounded-lg transition-colors "+(L===(s._id||s.id)?"bg-gray-300 text-gray-600":"bg-primary text-white hover:bg-primary-dark"),children:L===(s._id||s.id)?"Adding...":"Add to cart"})]})]})},s._id||s.id)})}),T&&e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":`${T.name} details`,className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",onClick:e=>{e.target===e.currentTarget&&E(null)},children:e.jsxs("div",{className:"bg-white rounded-lg max-w-xl w-full p-6 relative shadow-lg",children:[e.jsx("button",{onClick:()=>E(null),className:"absolute top-3 right-3 text-gray-500 hover:text-gray-800","aria-label":"Close",children:e.jsx(d,{})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:T.name}),e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:"text-lg font-bold text-primary",children:u(q(T))}),Number(T.discount||0)>0&&e.jsx("div",{className:"text-sm line-through text-gray-500",children:u(Number(T.price||0))}),Number(T.discount||0)>0&&e.jsxs("div",{className:"text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded",children:[T.discount,"% OFF"]})]}),T.description&&e.jsxs("div",{className:"mb-4 text-gray-700",children:[e.jsx("strong",{className:"block mb-1",children:"Description"}),e.jsx("div",{children:T.description})]}),"Package"===T.type&&(T.includedTests||T.tests)&&e.jsxs("div",{className:"mb-4",children:[e.jsx("strong",{className:"block mb-2",children:"Included Tests"}),e.jsx("ul",{className:"list-disc list-inside text-gray-700 space-y-1",children:(T.includedTests||T.tests).map((s,t)=>e.jsx("li",{children:"string"==typeof s?s:s.name||s},t))})]}),e.jsxs("div",{className:"mt-4 flex gap-3",children:[e.jsx("button",{onClick:()=>{z(T),E(null)},className:"flex-1 bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark",children:"Add to cart"}),e.jsx("button",{onClick:()=>E(null),className:"flex-1 border px-4 py-2 rounded",children:"Close"})]})]})}),e.jsx(h,{})]})};function h(){const[s,a]=t.useState(!1);return t.useEffect(()=>{const e=()=>a(window.scrollY>300);return window.addEventListener("scroll",e,{passive:!0}),()=>window.removeEventListener("scroll",e)},[]),s?e.jsx("button",{onClick:()=>window.scrollTo({top:0,behavior:"smooth"}),className:"fixed bottom-6 right-6 p-3 bg-primary text-white rounded-full shadow-lg hover:scale-105 transition-transform","aria-label":"Back to top",children:e.jsx(o,{})}):null}export{p as default};
